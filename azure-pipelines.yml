# Azure DevOps
# Build pipeline for PSDocs

trigger:
- master

pool:
  vmImage: VS2017-Win2016

variables:
  buildConfiguration: 'Release'
  versionNumber: '0.6.0'

# Use build number format. i.e. 0.6.0-Build181001
name: $(versionNumber)-Build$(date:yyMM)$(rev:rr)

steps:

# Install pipeline dependencies
- powershell: ./scripts/vstsbuild.ps1
  displayName: 'Install Invoke-Build'

# Invoke build
- powershell: Invoke-Build -Configuration $(buildConfiguration)
  displayName: 'Build module'

# Publish test results
- task: PublishTestResults@2
  displayName: 'Publish test results'
  inputs:
    testRunTitle: 'Pester unit tests'
    testResultsFormat: NUnit
    testResultsFiles: 'reports/*.xml'
    mergeTestResults: true
    buildConfiguration: $(buildConfiguration)
  condition: succeededOrFailed()

# Generate artifacts
- task: PublishBuildArtifacts@1
  displayName: 'Publish PSDocs module'
  inputs:
    PathtoPublish: out/modules/PSDocs
    ArtifactName: PSDocs

- task: PublishBuildArtifacts@1
  displayName: 'Publish PSDocs.Dsc module'
  inputs:
    PathtoPublish: out/modules/PSDocs.Dsc
    ArtifactName: PSDocs.Dsc
